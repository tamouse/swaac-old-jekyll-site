<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>GraphQL: Mutating an Object's State</title>
    <meta name="description" content="The development blog of tamouse">
    <link rel="stylesheet" href="/assets/css/main.css" />
    <link rel="canonical" href="http://swaac.tamouse.org/webdev/2017/08/20/graphql-mutating-an-objects-state/">
    <link href="/favicon.png" rel="icon">
</head>

    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
            <![endif]-->

        <nav id="topnav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Software as a Craft</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                
                <li><a href="/pages/learning">Learning</a></li>
                
                <li><a href="/pages/all_posts">Posts</a></li>
                
                <li><a href="/pages">Pages</a></li>
                
                <li><a href="/tags">Tags</a></li>
                
                <li><a href="/categories">Categories</a></li>
                
            </ul>
        </div><!--/.navbar-collapse -->
    </div>
</nav>

        <main id="main-content" class="container-fluid">
            <header class="page-header">
<h1>GraphQL: Mutating an Object's State</h1>
Aug 20, 2017


 &bullet; <ul class="link-list"><li>Categories:</li><li role="presentation"><a href="/categories/webdev">webdev</a></li></ul>
 &bullet; <ul class="link-list"><li>Tags: </li><li role="presentation"><a href="/tags/graphql">graphql</a></li> <li role="presentation"><a href="/tags/ruby">ruby</a></li> <li role="presentation"><a href="/tags/rails">rails</a></li> 
</header>

<article>
<p>In our project, we have a class, Job, that includes a state machine to
handle the different states the job can be in, such as <code class="highlighter-rouge">:unscheduled</code>,
<code class="highlighter-rouge">:scheduled</code>, <code class="highlighter-rouge">:in_progress</code>, <code class="highlighter-rouge">:completed</code> , etc.</p>

<p>The various state transitions can include some extra logic, such as
setting or clearing dates, recording the transition step, and a few
other things. This means I can’t really use a typical mutation of just
sending up attributes that change.</p>

<p>In addition, using the <code class="highlighter-rouge">graphql-ruby</code> gem with a root mutation that
breaks out into other mutations via the fields, I didn’t want to
populate that root mutation with a slew of entries.</p>

<p>My approach was to create a <code class="highlighter-rouge">transitionJob</code> field in the root
mutation:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">RootMutation</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">ObjectType</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="nb">name</span> <span class="s2">"RootMutation"</span>
  <span class="n">description</span> <span class="s2">"Root Mutation for Kickserv Application"</span>

  <span class="n">field</span> <span class="ss">:transitionJob</span><span class="p">,</span> <span class="no">JobGraphType</span><span class="p">,</span> <span class="s2">"Mutation that transitions a Job to a new state"</span> <span class="k">do</span>
    <span class="n">argument</span> <span class="ss">:id</span><span class="p">,</span> <span class="o">!</span><span class="n">types</span><span class="o">.</span><span class="no">Int</span><span class="p">,</span> <span class="s2">"Job ID (not the job_number)"</span>
    <span class="n">argument</span> <span class="ss">:action</span><span class="p">,</span> <span class="o">!</span><span class="n">types</span><span class="o">.</span><span class="no">String</span><span class="p">,</span> <span class="s2">"Action to perform on Job: (start|stop|restart|cancel|hold|unhold)"</span>
    <span class="n">resolve</span> <span class="no">JobTransitionMutation</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="c1"># other mutations...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>I created the PORO <code class="highlighter-rouge">JobTransitionMutation</code> to handle the actions
getting passed up to the graphql controller. This was also an
opportunity to refactor the actual transitions into and event PORO as
the same code occurred in two standard Rails controllers as well.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">JobTransitionMutation</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="n">job</span> <span class="o">=</span> <span class="no">Job</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="ss">:action</span><span class="p">].</span><span class="nf">to_sym</span>
    <span class="no">JobStateMachineEventCrank</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">context</span><span class="p">).</span><span class="nf">public_send</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="n">job</span><span class="p">.</span><span class="nf">reload</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Down in the React client, the query to match that mutation looks like:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">jobTransitionMutation</span> <span class="o">=</span> <span class="nx">gql</span><span class="err">`</span>
<span class="nx">mutation</span> <span class="nx">JobTransitionMutation</span><span class="p">(</span><span class="nx">$id</span><span class="err">:</span> <span class="nx">Int</span><span class="o">!</span><span class="p">,</span> <span class="nx">$action</span><span class="err">:</span> <span class="nb">String</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">transitionJob</span><span class="p">(</span><span class="nx">id</span><span class="err">:</span> <span class="nx">$id</span><span class="p">,</span> <span class="nx">action</span><span class="err">:</span> <span class="nx">$action</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="nx">status</span> <span class="nx">completed_on</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="err">`</span>
</code></pre>
</div>

<p>A few React components create buttons that the user can press to
change the various job states that are wrapped with the query above.</p>

<hr />

<p>This took me a while to figure out, bouncing back and forth between
the ruby side and the javascript side, and digging through a lot of
documentation. I want to give a shoutout to the great folks
at <a href="https://www.apollodata.com/">Apollo Data</a> for their excellent
documentation and to <a href="https://github.com/rmosolgo">Robert Mosolgo</a> and
the GitHub team for
the <a href="https://github.com/rmosolgo/graphql-ruby">graphql-ruby</a> gem.</p>

<hr />

<p>Future plans include converting the action into an Enum type.</p>

<p>I’m not quite sure what to do about the number of mutations we’re
going to need. Nearly everything in the client hangs off the root node
of the account, which includes job, estimates, invoices, customers,
employees, and a whole raft of other things. The root mutation seems
like it’s going to end up as large as the Rails <code class="highlighter-rouge">routes.rb</code> file if
I’m not careful.</p>

</article>
<hr>


<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'swaac'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


        </main>
        <hr />
<footer id="bottomnav" class="navbar navbar-default navbar-fixed-bottom" role="navigation">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-footer" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.tamouse.org">&copy; 2017 Tamara Temple</a>
    </div> <!-- /.navbat-header -->
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="//github.com/tamouse">github <i class="fa fa-github"></i></a></li>
        <li><a href="//twitter.com/tamouse">twitter <i class="fa fa-twitter"></i></a></li>
        <li><a href="/feed.xml">subscribe (RSS) <i class="fa fa-rss"></i></a></li>
        <li><a href="/pages/colophon/">Colophon</a></li>
      </ul>
    </div><!--/.navbar-collapse -->
  </div>  <!-- /.container-fluid -->
</footer>

        <!-- <script src="https://apis.google.com/js/plusone.js"></script> -->
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="/js/vendor/bootstrap.js"></script>
<script src="https://use.fontawesome.com/9e3a326427.js"></script>
<script src="/js/main.js"></script>

        

    </body>
</html>
