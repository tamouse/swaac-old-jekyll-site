<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Using Packer and Vagrant to Build Virtual Machines</title>
    <meta name="description" content="The development blog of tamouse">

    <link rel="stylesheet" href="" />
    <link rel="canonical" href="/swaac/2015/01/28/using-packer-and-vagrant-to-build-virtual-machines/">
    <link href="/favicon.png" rel="icon">
    <link rel="stylesheet" href="//cdn.datatables.net/1.10.4/css/jquery.dataTables.css" type="text/css" media="screen" />
</head>

  <body>
    <!--[if lt IE 8]>
        <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Software as a Craft</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/">Home</a></li>
        <li class="divider"></li>
        <li><a href="/pages/learning">Learning</a></li>
        <li class="divider"></li>
        <li><a href="/pages/about">About</a></li>
        <li class="divider"></li>
        <li><a href="/pages/swaac-intro">SWaaC Intro</a></li>
        <li class="divider"></li>
        <li><a href="/pages">Pages</a></li>
        <li class="divider"></li>
        <li><a href="/tags">Tags</a></li>
        <li class="divider"></li>
	<li><a href="/categories">Categories</a></li>
      </ul>
    </div><!--/.navbar-collapse -->
  </div>
</nav>


    <main class="container-fluid">
      <header class="page-header">
<h1>Using Packer and Vagrant to Build Virtual Machines</h1>
Jan 28, 2015


 &bullet; <ul class="link-list"><li>Categories:</li><li role="presentation"><a href="/categories/swaac">swaac</a></li></ul>
 &bullet; <ul class="link-list"><li>Tags: </li><li role="presentation"><a href="/tags/vagrant">vagrant</a></li> <li role="presentation"><a href="/tags/packer">packer</a></li> <li role="presentation"><a href="/tags/development">development</a></li> <li role="presentation"><a href="/tags/dev-env">dev-env</a></li> <li role="presentation"><a href="/tags/devops">devops</a></li> <li role="presentation"><a href="/tags/codeship">codeship</a></li> 
</header>

<article>
<p>The great <a href="http://www.codeship.com">codeship.com</a>’s
<a href="http://blog.codeship.com/author/florianmotlik/">Florian Motlik</a>
writes a superb tutorial on building virtual machines with
<a href="http://vagrantup.com">Vagrant</a> and
<a href="http://www.packer.io">Packer</a>. Being able to swiftly build virtual
machines is something I find essential for development, test, staging,
and deployment.</p>

<blockquote>

  <p>Sharing a common development environment with everyone on your team is
important. It is really hard though to keep the same dependencies,
database versions and other systems in sync between different machines.</p>

  <p><a href="http://vagrantup.com">Vagrant</a> is a great tool that helps with this and
manage the lifecycle of a virtual machine. As nice as Vagrant is,
provisioning machines with it has always been a pain. A couple of months
ago <a href="http://twitter.com/mitchellh">Mitchell Hashimoto</a>, the creator of
Vagrant, launched Packer.</p>

  <p>Packer lets you build Virtual Machine Images for different providers
from one json file. You can use the same file and commands to build an
image on AWS, Digital Ocean or for virtualbox and vagrant. This makes it
possible to use exactly the same system for development which you then
create in production.</p>

  <p>In this blog post we will show you how you can use Packer to build your
vagrant machines. In a follow up post we will focus on how we use Packer
for building all of our Continuous Deployment Infrastructure.</p>

  <h2 id="prerequisites-for-building-vagrant-machines">Prerequisites for building Vagrant Machines</h2>

  <p>You need <a href="https://www.virtualbox.org/">Virtualbox</a> and
<a href="http://www.packer.io/">Packer</a> installed. Virtualbox provides packages
for different Operating systems. Packer is even easier, just download
the right zip for your system and unzip it into your PATH</p>

  <h2 id="building-your-virtual-machine-with-packer">Building your Virtual Machine with Packer</h2>

  <p>We’ve collected all the files necessary to build a Vagrant Machine with
Packer in our <a href="https://github.com/flomotlik/packer-example">Packer
Example</a> repository.</p>

  <p>Packer uses builders, provisioners and post-processors as the main
configuraition attributes. A builder can for example be virtualbox or
AWS. A provisioner can be used to run different scripts. Post-processors
can be run after the machine image is done. For example converting a
Virtualbox image into a suitable image for vagrant is done in a
post-processor.</p>

  <p>Here is the main packer.json file. You can see the builder, provisioner
and post-processor defined:</p>
</blockquote>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></td><td class="code"><pre><span class="p">{</span>
  <span class="s2">"provisioners"</span><span class="err">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"shell"</span><span class="p">,</span>
      <span class="s2">"scripts"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"scripts/root_setup.sh"</span>
      <span class="p">],</span>
      <span class="s2">"override"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"virtualbox"</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">"execute_command"</span><span class="p">:</span> <span class="s2">"echo 'vagrant' | sudo -S sh ''"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"shell"</span><span class="p">,</span>
      <span class="s2">"scripts"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"scripts/setup.sh"</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="s2">"builders"</span><span class="err">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"virtualbox"</span><span class="p">,</span>
      <span class="s2">"boot_command"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"&lt;esc&gt;&lt;esc&gt;&lt;enter&gt;&lt;wait&gt;"</span><span class="p">,</span>
        <span class="s2">"/install/vmlinuz noapic preseed/url=http://:/preseed.cfg &lt;wait&gt;"</span><span class="p">,</span>
        <span class="s2">"debian-installer=en_US auto locale=en_US kbd-chooser/method=us &lt;wait&gt;"</span><span class="p">,</span>
        <span class="s2">"hostname= &lt;wait&gt;"</span><span class="p">,</span>
        <span class="s2">"fb=false debconf/frontend=noninteractive &lt;wait&gt;"</span><span class="p">,</span>
        <span class="s2">"keyboard-configuration/modelcode=SKIP keyboard-configuration/layout=USA keyboard-configuration/variant=USA console-setup/ask_detect=false &lt;wait&gt;"</span><span class="p">,</span>
        <span class="s2">"initrd=/install/initrd.gz -- &lt;enter&gt;&lt;wait&gt;"</span>
      <span class="p">],</span>
      <span class="s2">"boot_wait"</span><span class="p">:</span> <span class="s2">"4s"</span><span class="p">,</span>
      <span class="s2">"guest_os_type"</span><span class="p">:</span> <span class="s2">"Ubuntu_64"</span><span class="p">,</span>
      <span class="s2">"http_directory"</span><span class="p">:</span> <span class="s2">"http"</span><span class="p">,</span>
      <span class="s2">"iso_checksum"</span><span class="p">:</span> <span class="s2">"4d1a8b720cdd14b76ed9410c63a00d0e"</span><span class="p">,</span>
      <span class="s2">"iso_checksum_type"</span><span class="p">:</span> <span class="s2">"md5"</span><span class="p">,</span>
      <span class="s2">"iso_url"</span><span class="p">:</span> <span class="s2">"http://releases.ubuntu.com/13.10/ubuntu-13.10-server-amd64.iso"</span><span class="p">,</span>
      <span class="s2">"ssh_username"</span><span class="p">:</span> <span class="s2">"vagrant"</span><span class="p">,</span>
      <span class="s2">"ssh_password"</span><span class="p">:</span> <span class="s2">"vagrant"</span><span class="p">,</span>
      <span class="s2">"ssh_port"</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
      <span class="s2">"ssh_wait_timeout"</span><span class="p">:</span> <span class="s2">"10000s"</span><span class="p">,</span>
      <span class="s2">"shutdown_command"</span><span class="p">:</span> <span class="s2">"echo 'shutdown -P now' &gt; shutdown.sh; echo 'vagrant'|sudo -S sh 'shutdown.sh'"</span><span class="p">,</span>
      <span class="s2">"guest_additions_path"</span><span class="p">:</span> <span class="s2">"VBoxGuestAdditions_.iso"</span><span class="p">,</span>
      <span class="s2">"headless"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="s2">"virtualbox_version_file"</span><span class="p">:</span> <span class="s2">".vbox_version"</span><span class="p">,</span>
      <span class="s2">"vboxmanage"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span>
          <span class="s2">"modifyvm"</span><span class="p">,</span>
          <span class="s2">""</span><span class="p">,</span>
          <span class="s2">"--memory"</span><span class="p">,</span>
          <span class="s2">"2048"</span>
        <span class="p">],</span>
        <span class="p">[</span>
          <span class="s2">"modifyvm"</span><span class="p">,</span>
          <span class="s2">""</span><span class="p">,</span>
          <span class="s2">"--cpus"</span><span class="p">,</span>
          <span class="s2">"4"</span>
        <span class="p">]</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="s2">"post-processors"</span><span class="err">:</span> <span class="p">[</span><span class="s2">"vagrant"</span><span class="p">]</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
  <p>It builds for virtualbox and then exports it into vagrant. The http
folder contains a preseed.cfg file that is necessary to set up Ubuntu.</p>

  <p>In the scripts folder you can find a root_setup.sh and setup.sh
scripts.</p>

  <p>The root_setup.sh script sets up necessary packages and parameters for
Vagrant:</p>
</blockquote>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></td><td class="code"><pre><span class="c">#!/bin/bash</span>

<span class="nb">set</span> -e

<span class="c"># Updating and Upgrading dependencies</span>
sudo apt-get update -y -qq &gt; /dev/null
sudo apt-get upgrade -y -qq &gt; /dev/null

<span class="c"># Install necessary libraries for guest additions and Vagrant NFS Share</span>
sudo apt-get -y -q install linux-headers-<span class="k">$(</span>uname -r<span class="k">)</span> build-essential dkms nfs-common

<span class="c"># Install necessary dependencies</span>
sudo apt-get -y -q install curl wget git tmux firefox xvfb vim

<span class="c"># Setup sudo to allow no-password sudo for "admin"</span>
groupadd -r admin
usermod -a -G admin vagrant
cp /etc/sudoers /etc/sudoers.orig
sed -i -e <span class="s1">'/Defaults\s\+env_reset/a Defaults\texempt_group=admin'</span> /etc/sudoers
sed -i -e <span class="s1">'s/%admin ALL=(ALL) ALL/%admin ALL=NOPASSWD:ALL/g'</span> /etc/sudoers

<span class="c">#Install Redis</span>
sudo apt-get -y -q install libjemalloc1
wget -q http://d7jrzzvab3wte.cloudfront.net/checkbot/deb/redis-server_2.6.13-1_amd64.deb
sha1sum redis-server_2.6.13-1_amd64.deb | grep <span class="s1">'ab50cf037fd63e160946f8946b6d318cdf11800d'</span>
dpkg -i redis-server_2.6.13-1_amd64.deb
rm redis-server_2.6.13-1_amd64.deb

<span class="c"># Install required libraries for RVM and Ruby</span>
sudo apt-get -y -q install gawk libreadline6-dev zlib1g-dev libssl-dev libyaml-dev libsqlite3-dev sqlite3 autoconf libgdbm-dev libncurses5-dev automake libtool bison pkg-config libffi-dev libxml2-dev libxslt-dev libxml2


<span class="c"># Install Postgresql</span>
sudo apt-get -y -q install postgresql libpq-dev postgresql-contrib

<span class="c"># Set Password to test for user postgres</span>
sudo -u postgres psql -c <span class="s2">"ALTER USER postgres WITH PASSWORD 'test';"</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
  <p>The setup.sh script install different dependencies like ruby or redis to
set up the virtual machine exactly how you need it:</p>
</blockquote>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></td><td class="code"><pre><span class="c">#!/bin/bash</span>

<span class="nb">set</span> -e

<span class="nb">echo</span> <span class="s2">"Instaling for rof"</span>

<span class="c"># Installing vagrant keys</span>
mkdir ~/.ssh
chmod 700 ~/.ssh
<span class="nb">cd</span> ~/.ssh
wget --no-check-certificate <span class="s1">'https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub'</span> -O authorized_keys
chmod 600 ~/.ssh/authorized_keys
chown -R vagrant ~/.ssh

<span class="c"># Node.js Setup</span>
wget --retry-connrefused -q -O - https://raw.github.com/creationix/nvm/master/install.sh | sh
<span class="nb">source</span> ~/.nvm/nvm.sh

nvm install 0.10.18
nvm <span class="nb">alias </span>default 0.10.18

<span class="nb">echo</span> <span class="s2">"source ~/.nvm/nvm.sh"</span> &gt;&gt; ~/.bash_profile

<span class="c"># RVM Install</span>
wget --retry-connrefused -q -O - https://get.rvm.io | bash -s stable
<span class="nb">source</span> /home/vagrant/.rvm/scripts/rvm

rvm autolibs <span class="nb">read</span>-fail

rvm install 2.0.0-p195

gem install bundler zeus<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
  <p>You don’t have any limits what you can run in your virtual machine
through these scripts.</p>

  <h2 id="building-the-machine">Building the Machine</h2>

  <p>We’ve added a create_box script that makes it easy for you to get
started</p>
</blockquote>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="c">#!/bin/bash</span>

<span class="nb">set</span> -e

<span class="c">#export PACKER_LOG=1</span>
rm packer_virtualbox_virtualbox.box <span class="o">||</span> <span class="nb">true
</span>packer build -only<span class="o">=</span>virtualbox packer.json
vagrant box remove vagrant_machine <span class="o">||</span> <span class="nb">true
</span>vagrant box add vagrant_machine packer/packer_virtualbox_virtualbox.box<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
  <p>You will then see Virtualbox start up and build the machine</p>

  <p><img src="http://blog.codeship.io/wp-content/uploads/2013/11/packer-virtualbox.jpg" alt="Packer
Virtualbox" /></p>

  <p>Run the script and it will create the packer machine and import it into
vagrant. Then all you have to do is run</p>
</blockquote>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>vagrant destroy
vagrant up<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
  <p>And you have your development environment set up.</p>

  <p>You can now get into the machine with <code class="highlighter-rouge">vagrant ssh</code> and start coding.</p>

  <h2 id="conclusions">Conclusions</h2>

  <p>Vagrant is an incredibly powerful tool and together with Packer it is
easy to build development environments for your whole team.</p>

  <p>But this is only the beginning. Packer can go much further than just
providing your development environment. We are currently implementing
Packer as the tool to build all of our test infrastructure servers. This
new set of tools is great for <a href="http://blog.codeship.com/immutable-deployments/">Immutable
Infrastructure</a> and
<a href="https://www.codeship.com">Continuous Deployment</a> so you can build more
stable, secure and easy to change infrastructure than ever before.</p>

  <h2 id="additional-links">Additional Links</h2>

  <ul>
    <li><a href="http://www.packer.io/docs">Packer Documentation</a></li>
    <li><a href="http://docs.vagrantup.com/v2/">Vagrant Documentation</a></li>
    <li><a href="http://blog.codeship.com/immutable-deployments/">Our blog post about Immutable
Infrastructure</a></li>
  </ul>

  <h4 id="posts-you-may-also-find-interesting">Posts you may also find interesting</h4>

  <ul>
    <li><a href="http://blog.codeship.com/packer-ansible/" title="Permanent Link to Using Packer and Ansible to Build Immutable Infrastructure">Using Packer and Ansible to Build Immutable
Infrastructure</a></li>
    <li><a href="http://blog.codeship.com/immutable-deployments/" title="Permanent Link to About Immutable Infrastructure">About Immutable
Infrastructure</a></li>
  </ul>

</blockquote>

</article>
<hr>
<p><a href="http://blog.codeship.com/packer-vagrant-tutorial/">Source</a></p>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'swaac'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    </main>

    <hr />
<footer class="navbar navbar-default navbar-fixed-bottom" role="navigation">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-footer" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.tamouse.org">&copy; 2016 Tamara Temple</a>
    </div> <!-- /.navbat-header -->
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="//github.com/tamouse">github <i class="fa fa-github"></i></a></li>
        <li><a href="//twitter.com/tamouse">twitter <i class="fa fa-twitter"></i></a></li>
        <li><a href="/feed.xml">subscribe (RSS) <i class="fa fa-rss"></i></a></li>
        <li><a href="/pages/colophon/">Colophon</a></li>
      </ul>
    </div><!--/.navbar-collapse -->
  </div>  <!-- /.container-fluid -->
</footer>

    <!-- <script src="https://apis.google.com/js/plusone.js"></script> -->
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="/js/vendor/bootstrap.js"></script>
<script src="//cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/post_index.js"></script>

    

  </body>
</html>
